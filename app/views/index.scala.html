@(result: String, modelForm: Form[String])

@import helper._

@main("Scala PPL Compiler") {
<div class="container">
    <h1>Evaluate new Model</h1>
    @form(routes.Application.compileCode, 'id -> "runForm") {
    @textarea(modelForm("code"), 'rows -> "5", 'cols -> "20", '_label -> "Write the model below:", 'hidden -> true)
    <div id="editor" class="editor"></div>
    <input type="submit" value="Run" id="run"> (or press Ctrl + Enter)
    }
    @form(routes.Application.reset, 'id -> "resetForm") {
    <input type="submit" value="Reset"> (or press Shift + Enter)
    }

    <h2>Output size: @result.size</h2>

    <div id="outputDisplay" class="outputDisplay">@result</div>

    <script>
        function compileCode (codeStr, usage) {
            $.ajax({
               type: "POST",
               contentType: "application/json",
               url: '/compiler/compile',
               data: JSON.stringify({ code: codeStr }),
               dataType: "json",
               success: usage,
               error: function(j, t, e) {}
            });
        };
        var heightUpdateFunction = function(editor, id) {

            // http://stackoverflow.com/questions/11584061/
            var newHeight =
                      editor.getSession().getScreenLength()
                      * editor.renderer.lineHeight
                      + editor.renderer.scrollBar.getWidth();

            $(id).height(newHeight.toString() + "px");
            // $('#editor-section').height(newHeight.toString() + "px");

            // This call is required for the editor to fix all of
            // its inner structure for adapting to a change in size
            editor.resize();
        };

        var textarea = $('#code');

        var editor = ace.edit("editor");
        editor.setTheme("ace/theme/solarized_light");
        editor.getSession().setMode("ace/mode/scala");
        editor.focus();
        editor.getSession().setValue(textarea.val());
        editor.navigateFileEnd();

        heightUpdateFunction(editor, '#editor');
        editor.getSession().on('change', function () {
            textarea.val(editor.getSession().getValue());
            heightUpdateFunction(editor, '#editor');
        });

        textarea.val(editor.getSession().getValue());

        editor.commands.addCommand({
            name: "runCode",
            bindKey: {win: "Ctrl-Enter", mac: "Ctrl-Enter"},
            exec: function(editor) {
                document.getElementById("runForm").submit();
            }
        })
        editor.commands.addCommand({
            name: "resetCode",
            bindKey: {win: "Shift-Enter", mac: "Shift-Enter"},
            exec: function(editor) {
                console.log("resetting.")
                document.getElementById("resetForm").submit();
            }
        })


        var outputDisplay = ace.edit("outputDisplay");
        heightUpdateFunction(outputDisplay, '#outputDisplay');
        outputDisplay.setTheme("ace/theme/github");
        outputDisplay.getSession().setMode("ace/mode/markdown");
        outputDisplay.setReadOnly(true);  // false to make it editable
        outputDisplay.setShowPrintMargin(true);
        outputDisplay.setHighlightActiveLine(false);
        outputDisplay.setShowInvisibles(true);
        //outputDisplay.renderer.setShowGutter(false);
        outputDisplay.getSession().on('change', function () {
            textarea.val(editor.getSession().getValue());
            heightUpdateFunction(outputDisplay, '#outputDisplay');
        });

        compileCode("math.exp(1)", function(x) {console.log(x);});
    </script>
</div>
}